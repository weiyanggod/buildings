<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.app.mapper.FloorMapper">

    <resultMap id="getBuildingsFloorInfoByIdMap" type="com.example.app.model.entity.FloorInfo">
        <collection property="roomInfos" ofType="com.example.app.model.entity.FloorInfo"
                    select="getRoomListByFloorId"
                    column="{id=id}">
        </collection>
    </resultMap>

    <select id="getBuildingsFloorInfo" resultMap="getBuildingsFloorInfoByIdMap">
        select lc.field0026 as id, lc.field0023 as floorName, sum(fj.field0009) as floorArea
        from formson_1121 lc
                 left join formmain_1119 ly on lc.formmain_id = ly.ID
                 left join dbo.formmain_1124 fj on lc.field0026 = fj.field0061
        where ly.field0002 = #{id}
        group by lc.field0023, lc.field0026
        order by lc.field0023 ASC
    </select>

    <select id="getRoomListByFloorId" resultType="com.example.app.model.entity.RoomInfo">
        select fj.field0001                                             as id,
               fj.field0002                                             as roomNumber,
               enum.SHOWVALUE                                              status,
               ht.field0120                                                endTime,
               fj.field0009                                             as area,
               COALESCE(stkh.field0002, grkh.field0003, wbkh.field0003) as clientName
        from formmain_1124 fj
                 left join formson_1227 htmx on htmx.field0025 = fj.field0001
                 left join formmain_1226 ht on ht.ID = htmx.formmain_id
                 left join formson_1447 khmx on khmx.field0124 = htmx.field0025
                 left join formmain_1184 stkh on stkh.field0001 = ht.field0005
                 left join formmain_1141 grkh on grkh.field0002 = ht.field0005
                 left join formmain_1166 wbkh on wbkh.field0001 = ht.field0005
                 left join CTP_ENUM_ITEM enum on fj.field0008 = enum.ID
        where fj.field0061 = #{id}
          and fj.field0008 != '-5584945763428056712'
    </select>
</mapper>
